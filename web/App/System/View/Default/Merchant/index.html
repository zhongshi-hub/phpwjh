<include file="Public/header"/>
<div id="content-container">
    <div id="page-content">
        <div class="panel">
            <div class="panel-heading">
                <h3 class="panel-title">{:$title}</h3>

            </div>
            <!--筛选功能开始-->
            <div class="row">
                <div class="col-sm-12">
                    <form method="post" action="" ajax="n">
                        <div class="panel-body">
                            <div class="row ">
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">所属品牌</label>
                                        <select class="form-control" name="domain_auth" id="domain_auths" style="width: 300px;">
                                            <option value="">--请选择--</option>
                                            <volist name=":DomainAuthList()" id="v">
                                                <option value="{$v.web_authcode}">{$v.web_name}</option>
                                            </volist>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">详细信息</label>
                                        <input class="form-control" type="text" placeholder="支持 申请人姓名/联系电话/商户名称" name="search_val" value="">
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">所属代理</label>
                                        <input id="dialog_name" class="form-control dialog" type="text"  readonly>
                                        <input id="dialog_aid" class="form-control" type="hidden" name="aid" value="">
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">商户类型</label>
                                        <select  class="form-control" name="bus_type" >
                                            <option value="">所有类型</option>
                                            <option value="有营业执照">有营业执照</option>
                                            <option value="无营业执照">无营业执照</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">微信通道配置</label>
                                        <select  class="form-control" name="wx_alleys">
                                            <option value="">所有类型</option>
                                            <option value="1">已配置通道</option>
                                            <option value="2">未配置通道</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">支付宝通道配置</label>
                                        <select  class="form-control" name="ali_alleys">
                                            <option value="">所有类型</option>
                                            <option value="1">已配置通道</option>
                                            <option value="2">未配置通道</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button class="btn btn-success" type="submit">搜索</button>
                                    <button class="btn btn-default" value="ccl" name="export" type="submit"> <i class="fa fa-download"></i>导出</button>
                                </div>
                            </div>
                    </form>
                </div>
            </div>
            <!--筛选功能结束-->


            <div class="panel-body">
                <div class="pad-btm form-inline">
                    <div class="row">
                        <div class="col-sm-6 text-xs-center">
                            <div class="form-group">
                               <!-- <a href="{:U('abook')}" class="btn btn-purple"><i class="demo-pli-plus"></i>录入商户</a>-->
                                <button id="ABook" class="btn btn-purple"><i class="demo-pli-plus"></i>录入商户</button>
                            </div>
                        </div>
                        <div class="col-sm-6 text-xs-center text-right">
                        </div>
                    </div>
                </div>
                <table  class="table table-bordered table-hover toggle-circle table-vcenter" data-page-size="7">
                    <thead>
                    <tr>
                        <th class="text-center">所属品牌</th>
                        <th class="text-center">所属代理</th>
                        <th class="text-center">商户名称</th>
                        <th class="text-center">联系电话</th>
                        <th class="text-center">申请人姓名</th>
                        <th class="text-center">商户类型</th>
                        <th class="text-center">加入时间</th>
                        <!--<th class="text-center">更新时间</th>-->
                        <th class="text-center">微信通道</th>
                        <th class="text-center">支付宝通道</th>
                        <th class="text-center">信用认证</th>
                        <th class="text-center">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <foreach name="data" item="v">
                        <tr>
                            <td class="text-center">{$v.domain_auth|DomainName}</td>
                            <td class="text-center" width="100">{$v.agent_id|agent_name}</td>
                            <td class="text-center" width="200">{$v.mch_name}</td>
                            <td class="text-center">{$v.mch_tel}</td>
                            <td class="text-center">{$v.mch_card_name}</td>
                            <td class="text-center">{$v.mch_bus_type}</td>
                            <td class="text-center">{$v['ctime'|date='Y-m-d H:i:s',###]}</td>
                            <!--<td class="text-center">{$v['loadtime'|date='Y-m-d H:i:s',###]}</td>-->
                            <td class="text-center"><span onclick="Alleys_data({$v.id},'wx');" class="label <php>if(alleys_name($v['wx_alleys'])!='未配置通道'){ echo 'label-danger';}else{ echo 'label-dark';}</php>" style="background-color:<php>echo alleys_color($v['wx_alleys']);</php>;font-size:12px;font-weight:1;border-radius: 5px;cursor: pointer;">{$v.wx_alleys|alleys_name}</span></td>
                            <td class="text-center"><span onclick="Alleys_data({$v.id},'ali');" class="label <php>if(alleys_name($v['ali_alleys'])!='未配置通道'){ echo 'label-danger';}else{ echo 'label-dark';}</php>" style="background-color:<php>echo alleys_color($v['ali_alleys']);</php>;font-size:12px;font-weight:1;border-radius: 5px;cursor: pointer;">{$v.ali_alleys|alleys_name}</span></td>
                            <td class="text-center">
                                <if condition="$v['auth_status'] eq 1">
                                    <span class="label label-info" onclick="auth_alter({$v.id},0)" style="cursor:pointer;font-size:12px;font-weight:1;border-radius: 5px;">已认证</span>
                                    <else/>
                                    <span class="label label-default" onclick="auth_alter({$v.id},1)" style="cursor:pointer;font-size:12px;font-weight:1;border-radius: 5px;">未认证</span>
                                </if>
                            </td>
                            <td class="text-center">
                                <a href="{:U('Auditing_detail',array('id'=>$v['id']))}" class="btn btn-info btn-sm" type="button"  >基本信息</a>
                                <a href="{:U('api_way',array('id'=>$v['id']))}" class="btn btn-pink btn-sm" type="button"  >通道配置</a>
                                <a href="{:U('store',array('id'=>$v['id']))}" class="btn btn-purple btn-sm" type="button"  >门店列表</a>
                                <button class="btn btn-mint btn-sm" type="button" onclick="Transfer({$v.id});">过户代理</button>
                            </td>
                        </tr>
                    </foreach>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="11">
                            <div class="text-right">
                                <ul class="pagination">{$page}</ul>
                            </div>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- 模态框开始 -->
<div class="modal fade" id="alleys-data" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    <i class="pci-cross pci-circle"></i>
                </button>
                <h4 class="modal-title" id="S_title">
                    通道选择
                </h4>
            </div>
            <div class="modal-body">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <div class="panel-body demo-nifty-btn" style="text-align: left">
                                        <label class="control-label">请选择支付通道,未开通的通道无法切换!如需使用!请开通对应通道后切换!</label>
                                        <input id="alleys_id" name="alleys_id" type="hidden">
                                        <input id="alleys_type" name="alleys_type" type="hidden">
                                        <foreach name="api" item="v" key="k">
                                            <button id="{$v.alleys_type}" onclick="alleys_submit('{$v.alleys_type}')" style="border-color:<php>echo alleys_color($v['alleys_type']);</php>;background-color:<php>echo alleys_color($v['alleys_type']);</php>;" class="btn btn-info btn-rounded" disabled>{$v.alleys}</button>
                                        </foreach>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
            </div>
        </div>
    </div>
</div>
<!-- 模态框关闭 -->

<!-- 模态框开始 -->
<div class="modal fade" id="abook_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    <i class="pci-cross pci-circle"></i>
                </button>
                <h4 class="modal-title" id="S_title">
                    请选择要录入的品牌
                </h4>
            </div>
            <div class="modal-body">
                <form action="{:U('abook')}" method="get" ajax="n">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <div class="panel-body demo-nifty-btn" style="text-align: left">
                                    <label class="control-label">品牌列表</label>
                                    <select class="form-control" name="domain_auth" id="domain_auth">
                                        <volist name=":DomainAuthList()" id="v">
                                            <option value="{$v.web_authcode}">{$v.web_name}</option>
                                        </volist>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel-footer text-right">
                    <button class="btn btn-success" type="submit">确定并录入</button>
                </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- 模态框关闭 -->
<script>
    $('#domain_auth,#domain_auths').chosen();
    $('.chosen-container').css('width','500px');
    $('#domain_auths_chosen').css('width','200px');
    $('#ABook').click(function () {
        $('#abook_modal').modal('show');
    });

    $('.dialog').click(function () {
        var type= $('#domain_auths option:selected').val();
        if(!type){
            $.niftyNoty({
                type: 'danger',
                message : '<strong>请选择品牌后再使用代理功能</strong>',
                container : 'floating',
                timer : 5000
            });
        }else {
            layer.open({
                type: 2,
                title: '检索',
                area: ['700px', '530px'],
                fixed: false, //不固定
                maxmin: false,
                content: "{:U('Agent/dialog')}/domain_auth/" + type
            });
        }
    });

    //信用认证
    function auth_alter(id,type) {
        var info; //获取窗口索引
        if(type==1){
            info='您确认将此商户信用认证变更为<span style="color: red">已认证</span>状态吗?';
        }else{
            info='您确认将此商户信用认证变更为<span style="color: blue">未认证</span>状态吗?';
        }

        layer.alert(info, {
            title:'温馨提示',
            skin: 'layui-layer-molv'
            ,closeBtn: 1
            ,anim: 6 //动画类型
        },function(){
            layer.msg('信用认证处理中...请等待结果...', {
                icon: 16,
                shade: 0.01,
                time:300000
            });
            var ajax_data ={'id':id,'type':type};
            var actionurl ='{:U("auth_status_alter",array("Debug"=>"1"))}';
            $.post(actionurl, ajax_data, function (data) {
                if (data.status == 1) {
                    layer.msg(data.info, {time:5000,shade: 0.03});
                    window.location.reload();
                }
                else {
                    layer.closeAll();
                    $.niftyNoty({
                        type: 'danger',
                        message: '<strong>' + data.info + '</strong>',
                        container: 'floating',
                        timer: 5000
                    });
                }
            }, 'json');

        });
    }

    //切换通道
    function Alleys_data(id,type) {
        $('.demo-nifty-btn button').attr('disabled',true);
        //获取已开通的通道
        var actionurl="{:U('mch_alleys_data')}";
        var ajax_data={id:id};
        $.post(actionurl, ajax_data, function(data){
            if(data.status == 1){
                var  array=data.info.type;
                for (var k = 0, length = array.length; k < length; k++) {
                    $('#'+array[k]).attr('disabled',false);
                }
                $('#alleys_type').val(type);
                $('#alleys_id').val(data.info.cid);
                $('#alleys-data').modal('show');
            }else{
                $.niftyNoty({
                    type: 'danger',
                    message : '<strong>'+data.info+'</strong>',
                    container : 'floating',
                    timer : 5000
                });
            }
        }, 'json');
    }
    //提交
    function alleys_submit(type) {
        var cid=$('#alleys_id').val();
        var alleys_type= $('#alleys_type').val();
        var actionurl="{:U('mch_alleys_saves')}";
        var ajax_data={'cid':cid,'type':type,'alleys_type':alleys_type};
        $.post(actionurl, ajax_data, function(data){
            if(data.status == 1){
                $('#alleys-data').modal('hide');
                $.niftyNoty({
                    type: 'success',
                    message : '<strong>'+data.info+'</strong>',
                    container : 'floating',
                    timer : 5000
                });
                setTimeout(function(){
                    window.location.reload();
                }, 2000);

            }else{
                $.niftyNoty({
                    type: 'danger',
                    message : '<strong>'+data.info+'</strong>',
                    container : 'floating',
                    timer : 5000
                });
            }
        }, 'json');
        //alert(type+id);
    }


    function Transfer(id) {
        layer.prompt({title: '请输入要过户的代理ID或全名', formType: 0}, function(text){
            var ajax_data ={'id':id,'agent':text};
            $.post("{:U('transfer_agent')}", ajax_data, function(data){
                if(data.status == 1){
                    layer.msg( data.info, function(){

                    });
                    window.location.reload();
                }
                else{
                    layer.msg( data.info, function(){
                    });
                }
            }, 'json');

        });
    }
</script>


<include file="Public/footer"/>