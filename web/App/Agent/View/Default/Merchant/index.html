<include file="Public/header"/>
<div id="content-container">
    <div id="page-content">
        <div class="panel">
            <div class="panel-heading">
                <h3 class="panel-title">商户列表</h3>

            </div>
            <!--筛选功能开始-->
            <div class="row">
                <div class="col-sm-12">
                    <form method="post" action="" ajax="n">
                        <div class="panel-body">
                            <div class="row ">
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <label class="control-label">详细信息</label>
                                        <input class="form-control" type="text" placeholder="支持 申请人姓名/联系电话/商户名称" name="search_val" value="">
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">所属代理</label>
                                        <input id="dialog_name" class="form-control dialog" type="text"  value="">
                                        <input id="dialog_aid" class="form-control" type="hidden" name="aid" value="">
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">商户类型</label>
                                        <select  class="form-control" name="bus_type" >
                                            <option value="">所有类型</option>
                                            <option value="有营业执照">有营业执照</option>
                                            <option value="无营业执照">无营业执照</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">微信通道配置</label>
                                        <select  class="form-control" name="wx_alleys">
                                            <option value="">所有类型</option>
                                            <option value="1">已配置通道</option>
                                            <option value="2">未配置通道</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-2">
                                    <div class="form-group">
                                        <label class="control-label">支付宝通道配置</label>
                                        <select  class="form-control" name="ali_alleys">
                                            <option value="">所有类型</option>
                                            <option value="1">已配置通道</option>
                                            <option value="2">未配置通道</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button class="btn btn-success" type="submit">搜索</button>
                                </div>
                            </div>
                    </form>
                </div>
            </div>
            <!--筛选功能结束-->


            <div class="panel-body">
                <table  class="table table-bordered table-hover toggle-circle table-vcenter" data-page-size="7">
                    <thead>
                    <tr>
                        <th>所属代理</th>
                        <th style="width: 200px">商户名称</th>
                        <th class="text-center">联系电话</th>
                        <th class="text-center">申请人姓名</th>
                        <th class="text-center">商户类型</th>
                        <th class="text-center">加入时间</th>
                        <!--<th class="text-center">更新时间</th>-->
                        <th class="text-center">微信通道</th>
                        <th class="text-center">支付宝通道</th>
                        <th class="text-center">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <foreach name="data" item="v">
                        <tr>
                            <td>{$v.agent_id|agent_name}</td>
                            <td>{$v.mch_name}</td>
                            <td class="text-center">{$v.mch_tel}</td>
                            <td class="text-center">{$v.mch_card_name}</td>
                            <td class="text-center">{$v.mch_bus_type}</td>
                            <td class="text-center">{$v['ctime'|date='Y-m-d H:i:s',###]}</td>
                            <!--<td class="text-center">{$v['loadtime'|date='Y-m-d H:i:s',###]}</td>-->
                            <td class="text-center"><span onclick="Alleys_data({$v.id},'wx');" class="label <php>if(alleys_name($v['wx_alleys'])!='未配置通道'){ echo 'label-danger';}else{ echo 'label-dark';}</php>" style="font-size:12px;font-weight:1;border-radius: 5px;cursor: pointer;">{$v.wx_alleys|alleys_name}</span></td>
                            <td class="text-center"><span onclick="Alleys_data({$v.id},'ali');" class="label <php>if(alleys_name($v['ali_alleys'])!='未配置通道'){ echo 'label-danger';}else{ echo 'label-dark';}</php>" style="font-size:12px;font-weight:1;border-radius: 5px;cursor: pointer;">{$v.ali_alleys|alleys_name}</span></td>
                            <td class="text-center">
                                <a href="{:U('store',array('id'=>$v['id']))}" class="btn btn-purple btn-sm" type="button"  >门店列表</a>
                            </td>
                        </tr>
                    </foreach>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="11">
                            <div class="text-right">
                                <ul class="pagination">{$page}</ul>
                            </div>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- 模态框开始 -->
<div class="modal fade" id="alleys-data" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    <i class="pci-cross pci-circle"></i>
                </button>
                <h4 class="modal-title" id="S_title">
                    通道选择
                </h4>
            </div>
            <div class="modal-body">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <div class="panel-body demo-nifty-btn" style="text-align: left">
                                        <label class="control-label">请选择支付通道,未开通的通道无法切换!如需使用!请开通对应通道后切换!</label>
                                        <input id="alleys_id" name="alleys_id" type="hidden">
                                        <input id="alleys_type" name="alleys_type" type="hidden">
                                        <foreach name="api" item="v" key="k">
                                            <button id="{$v.alleys_type}" onclick="alleys_submit('{$v.alleys_type}')" class="btn btn-info btn-rounded" disabled>{$v.alleys}</button>
                                        </foreach>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>
<!-- 模态框关闭 -->
<script>

    $('.dialog').click(function () {
        layer.open({
            type: 2,
            title:'检索',
            area: ['700px', '530px'],
            fixed: false, //不固定
            maxmin: false,
            content: "{:U('Agent/dialog')}"
        });
    });
    //切换通道
    function Alleys_data(id,type) {
        $('.demo-nifty-btn button').attr('disabled',true);
        //获取已开通的通道
        var actionurl="{:U('mch_alleys_data')}";
        var ajax_data={id:id};
        $.post(actionurl, ajax_data, function(data){
            if(data.status == 1){
                var  array=data.info.type;
                for (var k = 0, length = array.length; k < length; k++) {
                    $('#'+array[k]).attr('disabled',false);
                }
                $('#alleys_type').val(type);
                $('#alleys_id').val(data.info.cid);
                $('#alleys-data').modal('show');
            }else{
                $.niftyNoty({
                    type: 'danger',
                    message : '<strong>'+data.info+'</strong>',
                    container : 'floating',
                    timer : 5000
                });
            }
        }, 'json');
    }
    //提交
    function alleys_submit(type) {
        var cid=$('#alleys_id').val();
        var alleys_type= $('#alleys_type').val();
        var actionurl="{:U('mch_alleys_saves')}";
        var ajax_data={'cid':cid,'type':type,'alleys_type':alleys_type};
        $.post(actionurl, ajax_data, function(data){
            if(data.status == 1){
                $('#alleys-data').modal('hide');
                $.niftyNoty({
                    type: 'success',
                    message : '<strong>'+data.info+'</strong>',
                    container : 'floating',
                    timer : 5000
                });
                setTimeout(function(){
                    window.location.reload();
                }, 2000);

            }else{
                $.niftyNoty({
                    type: 'danger',
                    message : '<strong>'+data.info+'</strong>',
                    container : 'floating',
                    timer : 5000
                });
            }
        }, 'json');
        //alert(type+id);
    }
</script>


<include file="Public/footer"/>