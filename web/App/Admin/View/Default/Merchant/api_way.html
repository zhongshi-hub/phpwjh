<include file="Public/header"/>
<style>
    .padding_data {
        padding: 7px;
        border-radius: 5px;
    }
    .send_template{
        font-size: 12px;padding: 5px;border: 1px dashed #3ccf05!important;background-color: antiquewhite;color: #2a9303;
    }
</style>
<div id="content-container">
    <div id="page-content">
        <div class="panel" style="margin: 9px;">
            <div class="panel-heading">
                <h3 class="panel-title">通道列表 - <span style="color:red;font-size: 20px;">{$mch_name}</span></h3>
            </div>

        </div>
        <volist name="data" key="k" id="v" mod="2">
            <eq name="v.alleys_type" value="Aliisv">
                <div class="col-lg-3 eq-box-lg">
                    <div class="panel">
                        <div class="panel-heading">
                            <!--<eq name="v['rest_in']" value="1">
                                <notempty name="v.mch_id">
                                    <eq name="v.load_status" value="1">
                                       <div class="panel-control">
                                          <span class="badge badge-purple padding_data"  style="cursor: pointer" onclick="sin('{$v.alleys}','{$v.alleys_type}',{$v.cid})">重新进件</span>
                                       </div>
                                    </eq>
                                </notempty>
                            </eq>-->

                            <div class="panel-control">
                                <eq name="v['appid_status']" value="1">
                                    <button onclick="AppId('{$v.alleys_type}',{$v.cid})" class="btn btn-rounded send_template">商户支付配置</button>
                                </eq>
                                <button onclick="send_success_template('{$v.alleys_type}',{$v.cid})" class="btn btn-rounded send_template" <if condition="($v['mch_id'] eq '') or ($v['send_success'] eq 1)">disabled</if> >发送通道开通提醒</button>
                            </div>
                            <h3 class="panel-title">{$v.alleys}</h3>
                        </div>
                        <div class="panel-body">
                            <p style="border-bottom: solid 1px #E4E4E4;font-size: 16px;padding-bottom: 5px;">基本信息</p>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label class="control-label">授权参数</label>
                                        <div class="form-control" style="border:none;padding: 0;">
                                            <php>$isToken=aliIsvToken($v['cid']);if(!empty($isToken)){</php>
                                            <span onclick="ali_isv({$v.cid},1)"
                                                  style="cursor: pointer" class="badge badge-info padding_data">{:aliIsvToken($v['cid'],'user_id')}</span>
                                            <php>}else{</php>
                                                <span onclick="ali_isv({$v.cid},0)"
                                                      style="cursor: pointer;background-color: #808080"
                                                      class="badge badge-mint padding_data add-tooltip"
                                                      data-toggle="tooltip" data-container="body" data-placement="bottom"
                                                      data-original-title="点击授权配置">未授权</span>
                                           <php>}</php>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6  text-right">
                                    <div class="form-group">
                                        <label class="control-label">商户费率</label>
                                        <div class="form-control" style="border:none;padding: 0;">
                                            <notempty name="v.rate">
                                                <span style="cursor: pointer" id="setRate" class="badge badge-info padding_data">{$v.rate} %.</span>
                                                <else/>
                                                <span id="setRate" class="badge badge-default padding_data"
                                                      style="color: #666;cursor: pointer">Null %.</span>
                                            </notempty>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label class="control-label">商户状态</label>
                                        <div class="form-control" style="border:none;padding: 0;">
                                            <switch name="v.status">
                                                <case value="1">
                                                    <span class="badge badge-success padding_data">审核通过</span>
                                                </case>
                                                <case value="2">
                                                <span class="badge badge-default padding_data"
                                                      style="color: #666;">拒绝驳回</span>
                                                </case>
                                                <case value="3">
                                                    <span class="badge badge-purple padding_data">审核中</span>
                                                </case>
                                                <default/>
                                                <span class="badge badge-dark padding_data" style="background-color: #6f7274">未授权</span>
                                            </switch>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6 text-right">
                                    <div class="form-group">
                                        <label class="control-label">通道状态</label>
                                        <div class="form-control" style="border:none;padding: 0;">
                                            <switch name="v.load_status">
                                                <case value="1">
                                                    <span class="badge badge-success padding_data" >激活成功</span>
                                                </case>
                                                <case value="2">
                                                <span class="badge badge-default padding_data"
                                                      style="color: #666;">已冻结</span>
                                                </case>
                                                <case value="3">
                                                <span class="badge badge-danger padding_data"
                                                      style="cursor:pointer;" onclick="mch_loading('{$v.mch_id}','{$v.alleys_type}')">信息被驳回</span>
                                                </case>
                                                <default/>
                                                <span class="badge badge-mint padding_data" style="cursor: pointer" >待激活</span>
                                            </switch>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p style="border-bottom: solid 1px #E4E4E4;font-size: 16px;padding-bottom: 5px;">信息操作</p>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <div class="form-control" style="border:none;padding: 0;cursor: pointer">
                                        <span class="badge badge-primary padding_data"
                                              onclick="m_data('{$v.alleys}','{$v.alleys_type}',{$v.cid})">商户信息</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <p style="border-bottom: solid 1px #E4E4E4;font-size: 16px;padding-bottom: 5px;">通道简介</p>
                            <dl>
                                <dd>
                                    <textarea style="resize:none" class="form-control" disabled><notempty name="v.make">{$v.make}<else/>无描述</notempty></textarea>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            <else/>
            <div class="col-lg-3 eq-box-lg">
                <div class="panel">
                    <div class="panel-heading">
                        <!--<eq name="v['rest_in']" value="1">
                            <notempty name="v.mch_id">
                                <eq name="v.load_status" value="1">
                                   <div class="panel-control">
                                      <span class="badge badge-purple padding_data"  style="cursor: pointer" onclick="sin('{$v.alleys}','{$v.alleys_type}',{$v.cid})">重新进件</span>
                                   </div>
                                </eq>
                            </notempty>
                        </eq>-->

                        <div class="panel-control">
                            <eq name="v['appid_status']" value="1">

                                <button onclick="AppId('{$v.alleys_type}',{$v.cid})" class="btn btn-rounded send_template">商户支付配置</button>

                            </eq>
                            <button onclick="send_success_template('{$v.alleys_type}',{$v.cid})" class="btn btn-rounded send_template" <if condition="($v['mch_id'] eq '') or ($v['send_success'] eq 1)">disabled</if> >发送通道开通提醒</button>
                        </div>
                        <h3 class="panel-title">{$v.alleys}</h3>
                    </div>
                    <div class="panel-body">
                        <p style="border-bottom: solid 1px #E4E4E4;font-size: 16px;padding-bottom: 5px;">基本信息</p>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label">商户编号</label>
                                    <div class="form-control" style="border:none;padding: 0;">
                                        <notempty name="v.mch_id">
                                            <span onclick="mch_data('{$v.alleys_type}',{$v.cid})"
                                                  style="cursor: pointer" class="badge badge-info padding_data">{$v.mch_id}</span>
                                            <else/>
                                            <span onclick="sin('{$v.alleys}','{$v.alleys_type}',{$v.cid})"
                                                  style="cursor: pointer"
                                                  class="badge badge-mint padding_data add-tooltip"
                                                  data-toggle="tooltip" data-container="body" data-placement="bottom"
                                                  data-original-title="点击进件">此通道未进件</span>
                                        </notempty>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6  text-right">
                                <div class="form-group">
                                    <label class="control-label">商户费率</label>
                                    <div class="form-control" style="border:none;padding: 0;">
                                        <notempty name="v.rate">
                                            <span style="cursor: pointer" data-name="{$v.alleys}" data-alley="{$v.alleys_type}"  data-cid="{$v.cid}" class="rest_rate badge badge-info padding_data">{$v.rate} %.</span>
                                            <else/>
                                            <span class="badge badge-default padding_data"
                                                  style="color: #666;">Null %.</span>
                                        </notempty>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="control-label">商户状态</label>
                                    <div class="form-control" style="border:none;padding: 0;">
                                        <switch name="v.status">
                                            <case value="1">
                                                <span class="badge badge-success padding_data">审核通过</span>
                                            </case>
                                            <case value="2">
                                                <span class="badge badge-default padding_data"
                                                      style="color: #666;">拒绝驳回</span>
                                            </case>
                                            <case value="3">
                                                <span class="badge badge-purple padding_data">审核中</span>
                                            </case>
                                            <default/>
                                            <span class="badge badge-dark padding_data">未进件</span>
                                        </switch>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 text-right">
                                <div class="form-group">
                                    <label class="control-label">通道状态</label>
                                    <div class="form-control" style="border:none;padding: 0;">
                                        <switch name="v.load_status">
                                            <case value="1">
                                                <span class="badge badge-success padding_data" onclick="mch_status('{$v.mch_id}','{$v.alleys_type}')">激活成功</span>
                                            </case>
                                            <case value="2">
                                                <span class="badge badge-default padding_data"
                                                      style="color: #666;">已冻结</span>
                                            </case>
                                            <case value="3">
                                                <span class="badge badge-danger padding_data"
                                                      style="cursor:pointer;" onclick="mch_loading('{$v.mch_id}','{$v.alleys_type}')">信息被驳回</span>
                                            </case>
                                            <default/>
                                            <span class="badge badge-mint padding_data" style="cursor: pointer" onclick="mch_status('{$v.mch_id}','{$v.alleys_type}')">审核中</span>
                                        </switch>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p style="border-bottom: solid 1px #E4E4E4;font-size: 16px;padding-bottom: 5px;">信息操作</p>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <div class="form-control" style="border:none;padding: 0;cursor: pointer">
                                        <span class="badge badge-primary padding_data"
                                              onclick="m_data('{$v.alleys}','{$v.alleys_type}',{$v.cid})">商户信息</span>
                                    </div>
                                </div>
                            </div>
                            <eq name="v['alter_status']" value="1">
                                <notempty name="v.mch_id">
                                    <eq name="v.load_status" value="1">
                                        <div class="col-sm-6 text-right">
                                            <div class="form-group">
                                                <div class="form-control" style="border:none;padding: 0;cursor: pointer">
                                                <span class="badge badge-danger padding_data"
                                                      onclick="alter('{$v.alleys}','{$v.alleys_type}',{$v.cid})">变更信息</span>
                                                </div>
                                            </div>
                                        </div>
                                    </eq>
                                </notempty>
                            </eq>

                        </div>

                        <p style="border-bottom: solid 1px #E4E4E4;font-size: 16px;padding-bottom: 5px;">通道简介</p>
                        <dl>
                            <dd>
                                <textarea style="resize:none" class="form-control" disabled><notempty name="v.make">{$v.make}<else/>无描述</notempty></textarea>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
            </eq>
        </volist>
    </div>
</div>

<!-- 支付宝ISV配置参数开始 -->
<div class="modal fade" id="ali_isv" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 400px">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    <i class="pci-cross pci-circle"></i>
                </button>
                <h4 class="modal-title">
                    授权配置  <span  id="s1" class="badge badge-info" style="border-radius: 5px;font-weight: 200;font-size:.8em;display: none">已授权</span> <span id="s0" class="badge badge-default" style="border-radius: 5px;font-weight: 200;font-size:.8em;color: #000000;display: none">待授权</span>
                </h4>
            </div>
            <div class="modal-body">
                <div class="tab-bases">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a data-toggle="tab" href="#tab-1" aria-expanded="true">授权二维码</a>
                        </li>
                        <li class="">
                            <a data-toggle="tab" href="#tab-2" aria-expanded="false">手动配置</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div id="tab-1" class="tab-pane fade active in" style="text-align: center">
                            <php>$url='http://'.$_SERVER["HTTP_HOST"].'/aliOauthUrl?id='.$_GET['id'];$url=Xencode($url);</php>
                            <img src="/Pays/Mch/QrData/url/{$url}"  width="300px" height="300px">
                            <div class="panel-footer text-center">
                                请将此二维码出示给商户使用支付宝扫码授权
                            </div>
                        </div>
                        <div id="tab-2" class="tab-pane fade">
                            <form action="{:U('Isv/setToken')}" method="post" >
                                <div class="panel-body">
                                    <div class="row" style="margin: 26px 0">
                                        <div class="col-sm-12">
                                            <div class="form-group">
                                                <label class="control-label">商户ID</label>
                                                <input class="form-control" type="text" name="user_id" placeholder="商户ID" required>
                                            </div>
                                        </div>
                                        <div class="col-sm-12">
                                            <div class="form-group">
                                                <label class="control-label">授权Token</label>
                                                <input class="form-control" type="text" name="app_auth_token" placeholder="授权Token">
                                            </div>
                                        </div>
                                        <div class="col-sm-12">
                                            <div class="form-group">
                                                <label class="control-label">授权AppId</label>
                                                <input class="form-control" type="text" name="appid" value="{:GetPayConfigs('ali_isv_appid')}" placeholder="ISV的应用APPID 引用总配置" readonly="">
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" name="mid" value="{$Think.get.id}">
                                    <button class="btn btn-success" type="submit">提交</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 模态框关闭 -->


<!-- 模态框开始 -->
<div class="modal fade" id="alleys-data" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 370px">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    <i class="pci-cross pci-circle"></i>
                </button>
                <h4 class="modal-title">
                    通道参数配置
                </h4>
            </div>
            <div class="modal-body">
                <form action="{:U('alley_mch_data')}" method="post">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label class="control-label">商户编号</label>
                                    <input class="form-control" type="text" name="mch_id" placeholder="商户编号" required>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label class="control-label">商户密钥</label>
                                    <input class="form-control" type="text" name="mch_key" placeholder="如有请填写">
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label class="control-label">附加参数</label>
                                    <input class="form-control" type="text" name="mch_appid" placeholder="如通道独立Appid及附加参数">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer text-right">
                        <input type="hidden" name="id" value="{$data.id}">
                        <button class="btn btn-success" type="submit">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- 模态框关闭 -->


<!-- 模态框开始 商户独立Appid发起支付配置 -->
<div class="modal fade" id="appid-data" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 370px">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    <i class="pci-cross pci-circle"></i>
                </button>
                <h4 class="modal-title">
                    商户独立公众号支付配置
                </h4>
            </div>
            <div class="modal-body">
                <form action="{:U('mch_appid_data')}" method="post">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <p>说明:</p>
                                    <p>默认支付使用平台配置的默认公众号支付，如支付需要使用商户自己的公众号支付，此处选择商户所使用的公众号!
                                    支付公众号需要拥有独立权(AppId/AppSecret没有在其他平台使用) 请在使用前确保当前配置的公众号授权域名及JS域名为: http(s)://<php>echo $_SERVER['HTTP_HOST'];</php>
                                    </p>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label class="control-label">商户支付公众号</label>
                                    <select data-placeholder="请选择..." id="pay_wx" name="pay_wxid" class="form-control" style="width: 300px;">
                                        <option value="0">-平台公众号-</option>
                                        <foreach name="weixin" item="v">
                                            <option value="{$v.id}">{$v.name}</option>
                                        </foreach>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer text-right">
                        <input type="hidden" name="appid_alleys" value="">
                        <input type="hidden" name="appid_mch_id" value="">
                        <button class="btn btn-success" type="submit">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- 模态框关闭 -->
<script>
    $('#pay_wx').chosen({search_contains:true,no_results_text: '没有找到相关的数据'});
    $(".chosen-container").css("width","100%");

    $('.rest_rate').click(function () {
        var cid=$(this).data('cid'),alley=$(this).data('alley');
        layer.prompt({title: '请输入商户'+$(this).data('name')+'费率(千分比)', formType: 0}, function(text){
            var ajax_data ={id:cid,type:alley,rate:text};
            $.post("{:U('setAlleyRate')}", ajax_data, function(data){
                if(data.status == 1){
                    layer.msg( data.info, function(){
                        window.location.reload();
                    });
                }
                else{
                    layer.msg( data.info);
                }
            }, 'json');

        });
    });
    $('#setRate').click(function () {
        layer.prompt({title: '请输入商户费率(千分比)', formType: 0}, function(text){
            var ajax_data ={id:'{$Think.get.id}',rate:text};
            $.post("{:U('Isv/setRate')}", ajax_data, function(data){
                if(data.status == 1){
                    layer.msg( data.info, function(){
                        window.location.reload();
                    });
                }
                else{
                    layer.msg( data.info);
                }
            }, 'json');

        });
    });
    function ali_isv(id,type) {
        $.post("{:U('Isv/getToken')}", {id:id}, function (data) {
            if (data.status == 1) {
                if(data.info.user_id){
                    $('#s1').show();
                }else{
                    $('#s0').show();
                }
                $('[name="mid"]').val(data.info.mid);
                $('[name="user_id"]').val(data.info.user_id);
                $('[name="app_auth_token"]').val(data.info.app_auth_token);
                $('#ali_isv').modal('show');
            }else{
                $.niftyNoty({
                    type: 'danger',
                    message: '<strong>' + data.info + '</strong>',
                    container: 'floating',
                    timer: 5000
                });
            }
        }, 'json');
    }

    //支付配置
    function AppId(type,id){
        $('[name="appid_alleys"]').val(type);
        $('[name="appid_mch_id"]').val(id);
        var actionurl = "{:U('mch_appid_data')}";
        var ajax_data = {'appid_mch_id': id, 'appid_alleys': type ,'type':'getData'};
        $.post(actionurl, ajax_data, function (data) {
             if (data.status == 1) {
                 var wx_id=data.info;
             }else{
                 var wx_id=0;
             }
             $("#pay_wx option[value="+wx_id+"]").attr("selected",true);
             $('#appid-data').modal('show');
             $("#pay_wx").trigger("chosen:updated")
        }, 'json');
    }

    function m_data(api, type, id) {
        layer.open({
            type: 2,
            title: api + '通道(商户信息)',
            area: ['80%', '85%'],
            fixed: false, //不固定
            maxmin: false,
            content: "{:U('mdata')}/type/" + type + "/id/" + id
        });
    }

    function alter(api, type, id) {
        window.location.href="{:U('alter')}/type/" + type + "/id/" + id+"?Debug=1";
    }


    function sin(api, type, id) {
        layer.open({
            type: 2,
            title: api + '通道进件',
            area: ['80%', '85%'],
            fixed: false, //不固定
            maxmin: true,
            content: "{:U('mdata')}/type/" + type + "/id/" + id + "/mch/sin"
        });
    }
    function mch_data(type, cid) {
        var actionurl = "{:U('mch_alleys_getapi')}";
        var ajax_data = {'cid': cid, 'type': type};
        $.post(actionurl, ajax_data, function (data) {
            if (data.status == 1) {
                $('[name="mch_id"]').val(data.info.mch_id);
                $('[name="id"]').val(data.info.id);
                $('[name="mch_key"]').val(data.info.mch_key);
                $('[name="mch_appid"]').val(data.info.mch_appid);
                $('#alleys-data').modal('show');
            }
            else {
                $.niftyNoty({
                    type: 'danger',
                    message: '<strong>' + data.info + '</strong>',
                    container: 'floating',
                    timer: 5000
                });
            }
        }, 'json');
    }

    //通道激活状态查询
    function  mch_status(mch,type) {
        var actionurl = "{:U('Pays/MchApi/gateway',array('Debug'=>1))}";
        var ajax_data = {'mch_id': mch, 'mch_type': type};
        $.post(actionurl, ajax_data, function (data) {
            if (data.status == 1) {
                $.niftyNoty({
                    type: 'success',
                    message: '<strong>' + data.info + '</strong>',
                    container: 'floating',
                    timer: 5000
                });
                window.location.reload();
            }
            else {
                $.niftyNoty({
                    type: 'danger',
                    message: '<strong>' + data.info + '</strong>',
                    container: 'floating',
                    timer: 5000
                });
            }
        }, 'json');
    }

    //通道驳回详细
    function mch_loading(mch,type) {
        var actionurl = "{:U('mch_loading',array('Debug'=>1))}";
        var ajax_data = {'mch_id': mch, 'mch_type': type};
        $.post(actionurl, ajax_data, function (data) {
            $.niftyNoty({
                type: 'danger',
                message: '<strong>' + data.info + '</strong>',
                container: 'floating',
                timer: 5000
            });
        });
    }


    //发送通道开通成功模板消息提醒
    function send_success_template(type,id) {
        layer.alert('每个商户每个通道只能发送一次开通提醒,发送一次后当前通道不可再次发送开通提醒!您确定要发送当前通道开通提醒吗?', {
            title:'温馨提示',
            skin: 'layui-layer-molv'
            ,closeBtn: 1
            ,anim: 6 //动画类型
        },function(){
            layer.msg('提醒发送中...请等待结果...', {
                icon: 16,
                shade: 0.01,
                time:300000
            });
            var ajax_data ={type:type,id:id,is_type:'pay'};
            var actionurl ='{:U("SendAlleysTemplate",array("Debug"=>"1"))}';
            $.post(actionurl, ajax_data, function (data) {
                if (data.status == 1) {
                    layer.closeAll();
                    $.niftyNoty({
                        type: 'success',
                        message : '<strong>'+data.info+'</strong>',
                        container : 'floating',
                        timer : 3000
                    });
                    setTimeout(function(){
                        window.location.reload();
                    }, 3000);
                }
                else {
                    layer.closeAll();
                    $.niftyNoty({
                        type: 'danger',
                        message: '<strong>' + data.info + '</strong>',
                        container: 'floating',
                        timer: 5000
                    });
                }
            }, 'json');

        });
    }
</script>
<include file="Public/footer"/>